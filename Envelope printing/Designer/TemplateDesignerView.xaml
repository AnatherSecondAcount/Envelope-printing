<UserControl x:Class="Envelope_printing.Designer.TemplateDesignerView"
 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
 xmlns:core="clr-namespace:Envelope_printing"
 mc:Ignorable="d"
 d:DesignHeight="600" d:DesignWidth="1000"
 Background="{StaticResource AppBackground}">

 <UserControl.Resources>
 <BooleanToVisibilityConverter x:Key="BoolToVis"/>
 <core:InverseBooleanToVisibilityConverter x:Key="InverseBoolToVis"/>
 <SolidColorBrush x:Key="SelectionBrush" Color="#FF0078D4"/>
 <core:ImagePathToBitmapConverter x:Key="ImagePathToBitmapConverter"/>
 <core:EqualityMultiConverter x:Key="EqualityMultiConverter"/>

 <!-- Thin line resize thumbs -->
 <Style x:Key="LineThumbVertical" TargetType="Thumb">
 <Setter Property="Width" Value="2"/>
 <Setter Property="Opacity" Value="0.6"/>
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="Thumb">
 <Border Background="#609E9E9E"/>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>
 <Style x:Key="LineThumbHorizontal" TargetType="Thumb">
 <Setter Property="Height" Value="2"/>
 <Setter Property="Opacity" Value="0.6"/>
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="Thumb">
 <Border Background="#609E9E9E"/>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>
 </UserControl.Resources>

 <!-- keyboard shortcuts -->
 <UserControl.InputBindings>
 <KeyBinding Modifiers="Control" Key="OemPlus" Command="{Binding ZoomInCommand}"/>
 <KeyBinding Modifiers="Control" Key="Add" Command="{Binding ZoomInCommand}"/>
 <KeyBinding Modifiers="Control" Key="OemMinus" Command="{Binding ZoomOutCommand}"/>
 <KeyBinding Modifiers="Control" Key="Subtract" Command="{Binding ZoomOutCommand}"/>
 <KeyBinding Modifiers="Control" Key="D0" Command="{Binding ResetZoomCommand}"/>
 <KeyBinding Modifiers="Control" Key="NumPad0" Command="{Binding ResetZoomCommand}"/>
 </UserControl.InputBindings>

 <Grid x:Name="Root">
 <!-- Center designer surface -->
 <ScrollViewer x:Name="DesignerScrollViewer"
 HorizontalScrollBarVisibility="Auto"
 VerticalScrollBarVisibility="Auto"
 Background="Transparent"
 MouseLeftButtonDown="OnViewportMouseLeftButtonDown"
 PreviewMouseDown="OnScrollViewerMouseDown"
 PreviewMouseMove="OnScrollViewerMouseMove"
 PreviewMouseUp="OnScrollViewerMouseUp">
 <Grid x:Name="ViewportGrid" Background="Transparent" MouseLeftButtonDown="OnViewportMouseLeftButtonDown">
 <Border HorizontalAlignment="Center" VerticalAlignment="Center" Background="Transparent">
 <Grid x:Name="DesignerArea" Background="Transparent">
 <Grid.LayoutTransform>
 <TransformGroup>
 <ScaleTransform ScaleX="3.78" ScaleY="3.78"/>
 <ScaleTransform ScaleX="{Binding ZoomFactor, FallbackValue=1.0}" ScaleY="{Binding ZoomFactor, FallbackValue=1.0}"/>
 </TransformGroup>
 </Grid.LayoutTransform>

 <Border x:Name="EnvelopeArea"
 Background="White" BorderBrush="#CCC" BorderThickness="0.5"
 Width="{Binding SelectedTemplateWidth, FallbackValue=600}"
 Height="{Binding SelectedTemplateHeight, FallbackValue=400}"
 MouseLeftButtonDown="OnCanvasMouseLeftButtonDown"
 Tag="{Binding}">
 <Border.ContextMenu>
 <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
 <MenuItem Header="Свойства холста" Command="{Binding PlacementTarget.Tag.ShowCanvasPropertiesCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
 </ContextMenu>
 </Border.ContextMenu>

 <Canvas x:Name="ItemsCanvas" ClipToBounds="True">
 <ItemsControl ItemsSource="{Binding SelectedTemplateItems}">
 <ItemsControl.ItemsPanel>
 <ItemsPanelTemplate>
 <Canvas />
 </ItemsPanelTemplate>
 </ItemsControl.ItemsPanel>
 <ItemsControl.ItemTemplate>
 <DataTemplate>
 <Grid Panel.ZIndex="{Binding ZIndex}" RenderTransform="{Binding CompositeTransform}" RenderTransformOrigin="0.5,0.5">
 <Border x:Name="ItemRoot"
 Width="{Binding Width}"
 Height="{Binding Height}"
 Background="{Binding Background}"
 BorderBrush="{Binding BorderBrush}"
 BorderThickness="{Binding BorderThickness}"
 CornerRadius="{Binding CornerRadius}"
 Opacity="{Binding Opacity}"
 MouseLeftButtonDown="OnItemMouseLeftButtonDown"
 MouseMove="OnItemMouseMove"
 MouseLeftButtonUp="OnItemMouseLeftButtonUp"
 SnapsToDevicePixels="True"
 Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}">
 <Border.ContextMenu>
 <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
 <MenuItem Header="Свойства..." Command="{Binding PlacementTarget.Tag.ShowItemPropertiesCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}" />
 <Separator />
 <MenuItem Header="Слой вверх" Command="{Binding PlacementTarget.Tag.MoveItemUpCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}" />
 <MenuItem Header="Слой вниз" Command="{Binding PlacementTarget.Tag.MoveItemDownCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}" />
 <Separator />
 <MenuItem Header="Удалить" Command="{Binding PlacementTarget.Tag.DeleteItemCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}" />
 </ContextMenu>
 </Border.ContextMenu>
 <Grid>
 <Border x:Name="TextHost" Padding="{Binding Padding}" Visibility="{Binding IsImage, Converter={StaticResource InverseBoolToVis}}">
 <TextBlock Text="{Binding DisplayText}"
 Foreground="{Binding Foreground}"
 FontFamily="{Binding FontFamily}"
 FontSize="{Binding DisplayFontSize}"
 FontWeight="{Binding FontWeight}"
 FontStyle="{Binding FontStyle}"
 TextAlignment="{Binding TextAlignment}"
 HorizontalAlignment="{Binding HorizontalAlignment}"
 VerticalAlignment="{Binding VerticalAlignment}"
 TextWrapping="Wrap" />
 </Border>
 <Image x:Name="ImageHost" Source="{Binding ImagePath, Converter={StaticResource ImagePathToBitmapConverter}}"
 Stretch="{Binding Stretch}" Visibility="{Binding IsImage, Converter={StaticResource BoolToVis}}" />
 <Border x:Name="SelectionOutline" BorderBrush="{StaticResource SelectionBrush}" BorderThickness="1" Visibility="Collapsed" />
 </Grid>
 </Border>
 <!-- Resize thumbs -->
 <Thumb x:Name="ResizeE" Style="{StaticResource LineThumbVertical}" HorizontalAlignment="Right" VerticalAlignment="Stretch" Cursor="SizeWE" Visibility="Collapsed" Opacity="0"
 DragStarted="OnResizeStart" DragDelta="OnResizeE" DragCompleted="OnResizeEnd" />
 <Thumb x:Name="ResizeS" Style="{StaticResource LineThumbHorizontal}" HorizontalAlignment="Stretch" VerticalAlignment="Bottom" Cursor="SizeNS" Visibility="Collapsed" Opacity="0"
 DragStarted="OnResizeStart" DragDelta="OnResizeS" DragCompleted="OnResizeEnd" />
 <!-- Rotate handle visible above the center, slightly offset -->
 <Thumb x:Name="RotateHandle" Width="16" Height="16" HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,-16,0,0" Cursor="Hand" Visibility="Collapsed"
 DragStarted="OnRotateStart" DragDelta="OnRotateDrag" DragCompleted="OnRotateEnd">
 <Thumb.Template>
 <ControlTemplate TargetType="Thumb">
 <Grid>
 <Ellipse Fill="#F0F0F0" Stroke="#7F000000" StrokeThickness="1"/>
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE7AD;" FontSize="10" Foreground="#6A6A6A" HorizontalAlignment="Center" VerticalAlignment="Center"/>
 </Grid>
 </ControlTemplate>
 </Thumb.Template>
 </Thumb>
 </Grid>
 <DataTemplate.Triggers>
 <DataTrigger Value="True">
 <DataTrigger.Binding>
 <MultiBinding Converter="{StaticResource EqualityMultiConverter}">
 <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext.SelectedTemplateItem" />
 <Binding />
 </MultiBinding>
 </DataTrigger.Binding>
 <Setter TargetName="SelectionOutline" Property="Visibility" Value="Visible" />
 <Setter TargetName="ResizeE" Property="Visibility" Value="Visible" />
 <Setter TargetName="ResizeS" Property="Visibility" Value="Visible" />
 <Setter TargetName="RotateHandle" Property="Visibility" Value="Visible" />
 </DataTrigger>
 </DataTemplate.Triggers>
 </DataTemplate>
 </ItemsControl.ItemTemplate>
 </ItemsControl>
 </Canvas>
 </Border>
 </Grid>
 </Border>
 </Grid>
 </ScrollViewer>

 <!-- Top center elements panel -->
 <Border x:Name="TopToolbar" Panel.ZIndex="10" HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,10,0,0" Padding="4" Style="{StaticResource OverlayPanelBorder}">
 <StackPanel Orientation="Horizontal">
 <Button Command="{Binding AddTextBlockCommand}" Style="{StaticResource ActionButtonStyle}" MinWidth="180">
 <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8D2;" Margin="0,0,8,0"/>
 <TextBlock Text="Добавить текст"/>
 </StackPanel>
 </Button>
 <Button Command="{Binding AddImageCommand}" Style="{StaticResource ActionButtonStyle}" MinWidth="200">
 <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8B8;" Margin="0,0,8,0"/>
 <TextBlock Text="Добавить изображение"/>
 </StackPanel>
 </Button>
 </StackPanel>
 </Border>

 <!-- Right properties panel (overlay) -->
 <Border x:Name="RightPanelBorder" Panel.ZIndex="20"
 HorizontalAlignment="Right" VerticalAlignment="Stretch" Margin="10" Padding="10"
 Style="{StaticResource OverlayPanelBorder}" MinWidth="380"
 Visibility="{Binding IsRightPanelOpen, Converter={StaticResource BoolToVis}}">
 <ScrollViewer VerticalScrollBarVisibility="Auto">
 <StackPanel>
 
 <!-- Canvas properties -->
 <StackPanel x:Name="CanvasProps">
 <StackPanel.Style>
 <Style TargetType="StackPanel">
 <Setter Property="Visibility" Value="Collapsed"/>
 <Style.Triggers>
 <DataTrigger Binding="{Binding IsCanvasPropertiesVisible}" Value="True">
 <Setter Property="Visibility" Value="Visible"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>
 </StackPanel.Style>
 <TextBlock Text="Свойства холста" Style="{StaticResource HeaderTextBlock}"/>
 <TextBlock Text="Название" Style="{StaticResource SubheaderTextBlock}"/>
 <TextBox Text="{Binding SelectedTemplateName, UpdateSourceTrigger=PropertyChanged}"/>
 <Grid Margin="0,8,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Ширина (мм)"/>
 <TextBox Grid.Column="1" Text="{Binding SelectedTemplateWidth, UpdateSourceTrigger=PropertyChanged}"/>
 </Grid>
 <Grid Margin="0,4,0,8">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Высота (мм)"/>
 <TextBox Grid.Column="1" Text="{Binding SelectedTemplateHeight, UpdateSourceTrigger=PropertyChanged}"/>
 </Grid>
 <TextBlock Text="Элементы на холсте" Style="{StaticResource SubheaderTextBlock}"/>
 <ListBox ItemsSource="{Binding CanvasItems}" SelectedItem="{Binding SelectedTemplateItem, Mode=TwoWay}" Height="180">
 <ListBox.ItemTemplate>
 <DataTemplate>
 <TextBlock Text="{Binding DisplayName}"/>
 </DataTemplate>
 </ListBox.ItemTemplate>
 </ListBox>
 </StackPanel>
 
 <!-- Item properties (minimal) -->
 <StackPanel x:Name="ItemProps" DataContext="{Binding SelectedTemplateItem}">
 <StackPanel.Style>
 <Style TargetType="StackPanel">
 <Setter Property="Visibility" Value="Collapsed"/>
 <Style.Triggers>
 <DataTrigger Binding="{Binding DataContext.IsItemPropertiesVisible, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
 <Setter Property="Visibility" Value="Visible"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>
 </StackPanel.Style>

 <TextBlock Text="Свойства элемента" Style="{StaticResource HeaderTextBlock}"/>

 <!-- Привязка к полю (только для текста) -->
 <StackPanel x:Name="BindingSelector" Visibility="{Binding IsImage, Converter={StaticResource InverseBoolToVis}}" Margin="0,4,0,4">
 <TextBlock Text="Привязка к полю получателя" Style="{StaticResource SubheaderTextBlock}"/>
 <DockPanel>
 <ComboBox Width="220" ItemsSource="{Binding DataContext.AvailableRecipientColumns, RelativeSource={RelativeSource AncestorType=UserControl}}"
 SelectedItem="{Binding ContentBindingPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
 <Button Content="Отвяжите" Margin="8,0,0,0" Command="{Binding DataContext.UnbindSelectedItemCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
 </DockPanel>
 </StackPanel>

 <Grid Margin="0,4,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Название"/>
 <TextBox Grid.Column="1" Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"/>
 </Grid>
 <Grid Margin="0,4,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Слой (0-10)"/>
 <TextBox Grid.Column="1" Text="{Binding ZIndex, UpdateSourceTrigger=PropertyChanged}"/>
 </Grid>

 <!-- Блок настроек текста (если это не изображение) -->
 <StackPanel x:Name="TextFormatting" Visibility="{Binding IsImage, Converter={StaticResource InverseBoolToVis}}" Margin="0,8,0,0">
 <TextBlock Text="Текст" Style="{StaticResource SubheaderTextBlock}"/>
 <Grid Margin="0,4,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Текст элемента"/>
 <TextBox Grid.Column="1" Text="{Binding StaticText, UpdateSourceTrigger=PropertyChanged}"/>
 </Grid>
 <Grid Margin="0,4,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Шрифт"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.FontFamilies, RelativeSource={RelativeSource AncestorType=UserControl}}" SelectedItem="{Binding FontFamily}"/>
 </Grid>
 <Grid Margin="0,4,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Размер"/>
 <TextBox Grid.Column="1" Text="{Binding FontSize, UpdateSourceTrigger=PropertyChanged}"/>
 </Grid>
 <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
 <CheckBox Content="Жирный" IsChecked="{Binding IsBold}" Margin="0,0,12,0"/>
 <CheckBox Content="Курсив" IsChecked="{Binding IsItalic}"/>
 </StackPanel>
 <Grid Margin="0,4,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Выравнивание текста"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.TextAlignments, RelativeSource={RelativeSource AncestorType=UserControl}}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding TextAlignmentString, Mode=TwoWay}"/>
 </Grid>
 
 <!-- Цвета и фон -->
 <Grid Margin="0,8,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/><ColumnDefinition Width='Auto'/></Grid.ColumnDefinitions>
 <TextBlock Text="Цвет текста"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.ColorChoices, RelativeSource={RelativeSource AncestorType=UserControl}}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding ForegroundChoice, Mode=TwoWay}"/>
 <Button Grid.Column="2" Content="Палитра..." Margin="8,0,0,0" Tag="ForegroundString" Click="OnPickColorClick"/>
 </Grid>
 <Grid Margin="0,4,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/><ColumnDefinition Width='Auto'/></Grid.ColumnDefinitions>
 <TextBlock Text="Фон"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.ColorChoices, RelativeSource={RelativeSource AncestorType=UserControl}}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding BackgroundChoice, Mode=TwoWay}"/>
 <Button Grid.Column="2" Content="Палитра..." Margin="8,0,0,0" Tag="BackgroundString" Click="OnPickColorClick"/>
 </Grid>
 <Grid Margin="0,4,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/><ColumnDefinition Width='Auto'/></Grid.ColumnDefinitions>
 <TextBlock Text="Граница"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.ColorChoices, RelativeSource={RelativeSource AncestorType=UserControl}}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding BorderBrushChoice, Mode=TwoWay}"/>
 <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="8,0,0,0">
 <Button Content="Цвет..." Tag="BorderBrushString" Click="OnPickColorClick"/>
 <TextBlock Text="Толщина" Margin="8,0,6,0" VerticalAlignment="Center"/>
 <TextBox Width="60" Text="{Binding BorderThickness, UpdateSourceTrigger=PropertyChanged}"/>
 </StackPanel>
 </Grid>
 
 <!-- Скругление, отступы и выравнивание элемента -->
 <Grid Margin="0,4,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Скругление углов"/>
 <ComboBox Grid.Column="1" SelectedValue="{Binding CornerRadiusValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" SelectedValuePath="Tag">
 <ComboBoxItem Content="0" Tag="0"/>
 <ComboBoxItem Content="2" Tag="2"/>
 <ComboBoxItem Content="4" Tag="4"/>
 <ComboBoxItem Content="6" Tag="6"/>
 <ComboBoxItem Content="8" Tag="8"/>
 </ComboBox>
 </Grid>
 <Grid Margin="0,4,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Внутренний отступ"/>
 <TextBox Grid.Column="1" Text="{Binding Padding, UpdateSourceTrigger=PropertyChanged}"/>
 </Grid>
 <Grid Margin="0,4,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Горизонтальное выравнивание"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.HorizontalAlignments, RelativeSource={RelativeSource AncestorType=UserControl}}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding HorizontalAlignmentString, Mode=TwoWay}"/>
 </Grid>
 <Grid Margin="0,4,0,8">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Вертикальное выравнивание"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.VerticalAlignments, RelativeSource={RelativeSource AncestorType=UserControl}}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding VerticalAlignmentString, Mode=TwoWay}"/>
 </Grid>
 </StackPanel>

 <!-- Настройки изображения (если это изображение) -->
 <StackPanel x:Name="ImageSettings" Visibility="{Binding IsImage, Converter={StaticResource BoolToVis}}" Margin="0,8,0,0">
 <TextBlock Text="Настройки изображения" Style="{StaticResource SubheaderTextBlock}"/>
 <Grid Margin="0,4,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Файл"/>
 <Grid Grid.Column="1">
 <Grid.ColumnDefinitions><ColumnDefinition Width="120"/><ColumnDefinition/></Grid.ColumnDefinitions>
 <Button Grid.Column="0" Content="Выбрать..." Width="120" HorizontalAlignment="Left" Command="{Binding DataContext.ChangeImageCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
 <TextBlock Grid.Column="1" Margin="12,2,0,0" Text="{Binding ImagePath}" TextWrapping="Wrap"/>
 </Grid>
 </Grid>
 <Grid Margin="0,4,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Режим растяжения"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.StretchModes, RelativeSource={RelativeSource AncestorType=UserControl}}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding StretchString, Mode=TwoWay}"/>
 </Grid>
 </StackPanel>

 <!-- Общие -->
 <Grid Margin="0,8,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Прозрачность"/>
 <Slider Grid.Column="1" Minimum="0" Maximum="1" SmallChange="0.01" LargeChange="0.1" TickFrequency="0.1" IsSnapToTickEnabled="False" Value="{Binding Opacity, Mode=TwoWay}"/>
 </Grid>
 <Grid Margin="0,4,0,0">
 <Grid.ColumnDefinitions><ColumnDefinition/><ColumnDefinition/></Grid.ColumnDefinitions>
 <TextBlock Text="Поворот (°)"/>
 <TextBox Grid.Column="1" Text="{Binding RotationDegrees, UpdateSourceTrigger=PropertyChanged}"/>
 </Grid>
</StackPanel>
 </StackPanel>
 </ScrollViewer>
 </Border>

 <!-- Left overlay panel -->
 <Border x:Name="LeftOverlayPanel" Panel.ZIndex="20" HorizontalAlignment="Left" VerticalAlignment="Stretch" Margin="10" Padding="10" Style="{StaticResource OverlayPanelBorder}"
 Visibility="{Binding IsLeftPanelVisible, Converter={StaticResource BoolToVis}}">
 <StackPanel>
 <TextBlock Text="Холсты" Style="{StaticResource HeaderTextBlock}"/>
 <ListBox ItemsSource="{Binding Templates}" SelectedItem="{Binding SelectedTemplate}" DisplayMemberPath="Name" Height="200"/>
 <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
 <Button Content="Новый" Command="{Binding AddTemplateCommand}" Style="{StaticResource ActionButtonStyle}"/>
 <Button Content="Удалить" Command="{Binding RemoveTemplateCommand}" IsEnabled="{Binding IsTemplateSelected}" Style="{StaticResource ActionButtonStyle}"/>
 </StackPanel>
 </StackPanel>
 </Border>

 <!-- Bottom overlay -->
 <StackPanel Orientation="Horizontal" Panel.ZIndex="10" HorizontalAlignment="Center" VerticalAlignment="Bottom" Margin="0,0,0,10">
 <Border x:Name="ZoomPanelBorder" Padding="6" Style="{StaticResource OverlayPanelBorder}">
 <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
 <Button Style="{StaticResource FileButtonStyle}" Content="-" Command="{Binding ZoomOutCommand}" MinWidth="44" Padding="12,4"/>
 <Button x:Name="ZoomPercentButton" Style="{StaticResource FileButtonStyle}" Command="{Binding ResetZoomCommand}" MinWidth="64" Padding="16,4" PreviewMouseRightButtonUp="OnZoomPercentRightClick" Margin="8,0,8,0">
 <TextBlock Text="{Binding ZoomPercentage, StringFormat={}{0}%}"/>
 </Button>
 <Button Style="{StaticResource FileButtonStyle}" Content="+" Command="{Binding ZoomInCommand}" MinWidth="44" Padding="12,4"/>
 </StackPanel>
 </Border>
 <Border Margin="10,0,0,0" Padding="4" Style="{StaticResource OverlayPanelBorder}">
 <Button Command="{Binding SaveChangesCommand}" Style="{StaticResource ActionButtonStyle}" MinWidth="160">
 <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE74E;" Margin="0,0,8,0"/>
 <TextBlock Text="Сохранить"/>
 </StackPanel>
 </Button>
 </Border>
 </StackPanel>

 <!-- Left panel toggle -->
 <Button x:Name="ArrowToggle" Panel.ZIndex="21" Command="{Binding ToggleLeftPanelCommand}" HorizontalAlignment="Left" VerticalAlignment="Bottom" Margin="10,0,0,18" Style="{StaticResource FloatingArrowButtonStyle}">
 <Button.RenderTransform><TranslateTransform X="-8"/></Button.RenderTransform>
 <TextBlock Text="&#xE76C;"/>
 </Button>

 <!-- Zoom popup -->
 <Popup x:Name="ZoomPopup" Placement="Top" PlacementTarget="{Binding ElementName=ZoomPanelBorder}" StaysOpen="False" AllowsTransparency="True" PopupAnimation="Fade">
 <Border x:Name="ZoomPopupContent" Style="{StaticResource OverlayPanelBorder}" Padding="8" MinHeight="44">
 <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
 <Slider Width="240" Minimum="20" Maximum="200" Value="{Binding ZoomPercentage, Mode=TwoWay}" TickFrequency="10" IsSnapToTickEnabled="True"/>
 </StackPanel>
 </Border>
 </Popup>
 </Grid>
</UserControl>