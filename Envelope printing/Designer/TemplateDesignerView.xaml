<UserControl x:Class="Envelope_printing.Designer.TemplateDesignerView"
 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
 xmlns:core="clr-namespace:Envelope_printing"
 xmlns:sys="clr-namespace:System;assembly=mscorlib"
 mc:Ignorable="d"
 d:DesignHeight="600" d:DesignWidth="1000"
 Background="{StaticResource AppBackground}">

 <UserControl.Resources>
 <!-- resources -->
 <BooleanToVisibilityConverter x:Key="BoolToVis"/>
 <core:InverseBooleanToVisibilityConverter x:Key="InverseBoolToVis"/>
 <SolidColorBrush x:Key="SelectionBrush" Color="#FF0078D4"/>
 <core:ImagePathToBitmapConverter x:Key="ImagePathToBitmapConverter"/>
 <core:EqualityMultiConverter x:Key="EqualityMultiConverter"/>

 <!-- Floating circular toggle button used for panel toggle -->
 <Style x:Key="FloatingArrowButtonStyle" TargetType="ToggleButton">
 <Setter Property="Width" Value="44"/>
 <Setter Property="Height" Value="44"/>
 <Setter Property="Padding" Value="0"/>
 <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
 <Setter Property="BorderBrush" Value="{DynamicResource FieldBorderBrush}"/>
 <Setter Property="BorderThickness" Value="1"/>
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="ToggleButton">
 <Border x:Name="root" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="22">
 <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
 </Border>
 <ControlTemplate.Triggers>
 <Trigger Property="IsMouseOver" Value="True">
 <Setter TargetName="root" Property="Background" Value="{DynamicResource ButtonHoverBrush}"/>
 <Setter TargetName="root" Property="BorderBrush" Value="{DynamicResource ButtonHoverBorderBrush}"/>
 </Trigger>
 <Trigger Property="IsPressed" Value="True">
 <Setter TargetName="root" Property="Background" Value="{DynamicResource ButtonPressedBrush}"/>
 <Setter TargetName="root" Property="BorderBrush" Value="{DynamicResource ButtonPressedBorderBrush}"/>
 </Trigger>
 <Trigger Property="IsChecked" Value="True">
 <Setter TargetName="root" Property="Background" Value="{DynamicResource ButtonPressedBrush}"/>
 </Trigger>
 <Trigger Property="IsEnabled" Value="False">
 <Setter TargetName="root" Property="Opacity" Value="0.6"/>
 </Trigger>
 </ControlTemplate.Triggers>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>

 <!-- Thin line resize thumbs -->
 <Style x:Key="LineThumbVertical" TargetType="Thumb">
 <Setter Property="Width" Value="2"/>
 <Setter Property="Opacity" Value="0.6"/>
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="Thumb">
 <Border Background="#609E9E9E"/>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>
 <Style x:Key="LineThumbHorizontal" TargetType="Thumb">
 <Setter Property="Height" Value="2"/>
 <Setter Property="Opacity" Value="0.6"/>
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="Thumb">
 <Border Background="#609E9E9E"/>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>
 <!-- Even smaller rotate thumb styled like a default button; always on top of item -->
 <Style x:Key="RotateThumbStyle" TargetType="Thumb">
 <Setter Property="Width" Value="12"/>
 <Setter Property="Height" Value="12"/>
 <Setter Property="Cursor" Value="Hand"/>
 <Setter Property="Opacity" Value="0.95"/>
 <Setter Property="Panel.ZIndex" Value="1000"/>
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="Thumb">
 <Border CornerRadius="2" Background="{DynamicResource {x:Static SystemColors.ControlLightBrushKey}}" BorderBrush="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}" BorderThickness="1">
 <TextBlock Text="&#xE7AD;" FontFamily="Segoe MDL2 Assets" FontSize="9" HorizontalAlignment="Center" VerticalAlignment="Center"/>
 </Border>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>
 </UserControl.Resources>

 <!-- keyboard shortcuts -->
 <UserControl.InputBindings>
 <KeyBinding Modifiers="Control" Key="OemPlus" Command="{Binding ZoomInCommand}"/>
 <KeyBinding Modifiers="Control" Key="Add" Command="{Binding ZoomInCommand}"/>
 <KeyBinding Modifiers="Control" Key="OemMinus" Command="{Binding ZoomOutCommand}"/>
 <KeyBinding Modifiers="Control" Key="Subtract" Command="{Binding ZoomOutCommand}"/>
 <KeyBinding Modifiers="Control" Key="D0" Command="{Binding ResetZoomCommand}"/>
 <KeyBinding Modifiers="Control" Key="NumPad0" Command="{Binding ResetZoomCommand}"/>
 </UserControl.InputBindings>

 <Grid x:Name="Root">
 <!-- Center designer surface -->
 <ScrollViewer x:Name="DesignerScrollViewer"
 HorizontalScrollBarVisibility="Auto"
 VerticalScrollBarVisibility="Auto"
 Background="Transparent"
 MouseLeftButtonDown="OnViewportMouseLeftButtonDown"
 PreviewMouseDown="OnScrollViewerMouseDown"
 PreviewMouseMove="OnScrollViewerMouseMove"
 PreviewMouseUp="OnScrollViewerMouseUp">
 <Grid x:Name="ViewportGrid" Background="Transparent" MouseLeftButtonDown="OnViewportMouseLeftButtonDown">
 <Border HorizontalAlignment="Center" VerticalAlignment="Center" Background="Transparent">
 <Grid x:Name="DesignerArea" Background="Transparent">
 <Grid.LayoutTransform>
 <TransformGroup>
 <ScaleTransform ScaleX="3.78" ScaleY="3.78"/>
 <ScaleTransform ScaleX="{Binding ZoomFactor, FallbackValue=1.0}" ScaleY="{Binding ZoomFactor, FallbackValue=1.0}"/>
 </TransformGroup>
 </Grid.LayoutTransform>

 <Border x:Name="EnvelopeArea"
 Background="White"
 BorderBrush="#00000000" BorderThickness="0"
 Width="{Binding SelectedTemplateWidth, FallbackValue=600}"
 Height="{Binding SelectedTemplateHeight, FallbackValue=400}"
 MouseLeftButtonDown="OnCanvasMouseLeftButtonDown"
 Tag="{Binding}">
 <Border.ContextMenu>
 <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
 <MenuItem Header="Свойства холста" Command="{Binding PlacementTarget.Tag.ShowCanvasPropertiesCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
 </ContextMenu>
 </Border.ContextMenu>

 <Grid>
 <!-- Background image for canvas -->
 <Image Source="{Binding CanvasBackgroundImagePath}" Stretch="{Binding CanvasBackgroundStretch}"/>
 <Canvas x:Name="ItemsCanvas" ClipToBounds="True">
 <ItemsControl ItemsSource="{Binding SelectedTemplateItems}">
 <ItemsControl.ItemsPanel>
 <ItemsPanelTemplate>
 <Canvas />
 </ItemsPanelTemplate>
 </ItemsControl.ItemsPanel>
 <!-- Make layering work by binding Panel.ZIndex on the container -->
 <ItemsControl.ItemContainerStyle>
 <Style TargetType="ContentPresenter">
 <Setter Property="Panel.ZIndex" Value="{Binding ZIndex}"/>
 </Style>
 </ItemsControl.ItemContainerStyle>
 <ItemsControl.ItemTemplate>
 <DataTemplate>
 <Grid RenderTransform="{Binding CompositeTransform}" RenderTransformOrigin="0.5,0.5">
 <Border x:Name="ItemRoot"
 Width="{Binding Width}"
 Height="{Binding Height}"
 Background="{Binding Background}"
 BorderBrush="{Binding BorderBrush}"
 BorderThickness="{Binding BorderThickness}"
 CornerRadius="{Binding CornerRadius}"
 Opacity="{Binding Opacity}"
 MouseLeftButtonDown="OnItemMouseLeftButtonDown"
 MouseMove="OnItemMouseMove"
 MouseLeftButtonUp="OnItemMouseLeftButtonUp"
 SnapsToDevicePixels="True"
 Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}">
 <Border.ContextMenu>
 <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
 <MenuItem Header="Свойства..." Command="{Binding PlacementTarget.Tag.ShowItemPropertiesCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}" />
 <Separator />
 <MenuItem Header="Слой вверх" Command="{Binding PlacementTarget.Tag.MoveItemUpCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}" />
 <MenuItem Header="Слой вниз" Command="{Binding PlacementTarget.Tag.MoveItemDownCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}" />
 <Separator />
 <MenuItem Header="Удалить" Command="{Binding PlacementTarget.Tag.DeleteItemCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" CommandParameter="{Binding}" />
 </ContextMenu>
 </Border.ContextMenu>
 <Grid>
 <Border x:Name="TextHost" Padding="{Binding Padding}" Visibility="{Binding IsImage, Converter={StaticResource InverseBoolToVis}}">
 <TextBlock Text="{Binding DisplayText}"
 Foreground="{Binding Foreground}"
 FontFamily="{Binding FontFamily}"
 FontSize="{Binding DisplayFontSize}"
 FontWeight="{Binding FontWeight}"
 FontStyle="{Binding FontStyle}"
 TextAlignment="{Binding TextAlignment}"
 HorizontalAlignment="{Binding HorizontalAlignment}"
 VerticalAlignment="{Binding VerticalAlignment}"
 TextWrapping="Wrap" />
 </Border>
 <Image x:Name="ImageHost" Source="{Binding ImagePath, Converter={StaticResource ImagePathToBitmapConverter}}"
 Stretch="{Binding Stretch}" Visibility="{Binding IsImage, Converter={StaticResource BoolToVis}}" />
 <Border x:Name="SelectionOutline" BorderBrush="{StaticResource SelectionBrush}" BorderThickness="1" Visibility="Collapsed" />
 <!-- Rotate thumb above the center with a small gap -->
 <Thumb x:Name="RotateThumb" Style="{StaticResource RotateThumbStyle}" HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,-16,0,0" Visibility="Collapsed"
 DragStarted="OnRotateStart" DragDelta="OnRotateDrag" DragCompleted="OnRotateEnd"/>
 </Grid>
 </Border>
 <!-- Resize thumbs -->
 <Thumb x:Name="ResizeE" Style="{StaticResource LineThumbVertical}" HorizontalAlignment="Right" VerticalAlignment="Stretch" Cursor="SizeWE" Visibility="Collapsed" Opacity="0"
 DragStarted="OnResizeStart" DragDelta="OnResizeE" DragCompleted="OnResizeEnd" />
 <Thumb x:Name="ResizeS" Style="{StaticResource LineThumbHorizontal}" HorizontalAlignment="Stretch" VerticalAlignment="Bottom" Cursor="SizeNS" Visibility="Collapsed" Opacity="0"
 DragStarted="OnResizeStart" DragDelta="OnResizeS" DragCompleted="OnResizeEnd" />
 <!-- Corner thumb: tiny and invisible, but hit-testable -->
 <Thumb x:Name="ResizeSE" Width="4" Height="4" HorizontalAlignment="Right" VerticalAlignment="Bottom" Cursor="SizeNWSE" Visibility="Collapsed" Opacity="0"
 DragStarted="OnResizeStart" DragDelta="OnResizeSE" DragCompleted="OnResizeEnd">
 <Thumb.Template>
 <ControlTemplate TargetType="Thumb">
 <Border Background="Transparent"/>
 </ControlTemplate>
 </Thumb.Template>
 </Thumb>
 </Grid>
 <DataTemplate.Triggers>
 <DataTrigger Value="True">
 <DataTrigger.Binding>
 <MultiBinding Converter="{StaticResource EqualityMultiConverter}">
 <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext.SelectedTemplateItem" />
 <Binding />
 </MultiBinding>
 </DataTrigger.Binding>
 <Setter TargetName="SelectionOutline" Property="Visibility" Value="Visible" />
 <Setter TargetName="ResizeE" Property="Visibility" Value="Visible" />
 <Setter TargetName="ResizeS" Property="Visibility" Value="Visible" />
 <Setter TargetName="ResizeSE" Property="Visibility" Value="Visible" />
 <Setter TargetName="RotateThumb" Property="Visibility" Value="Visible" />
 </DataTrigger>
 </DataTemplate.Triggers>
 </DataTemplate>
 </ItemsControl.ItemTemplate>
 </ItemsControl>
 </Canvas>
 </Grid>
 </Border>
 </Grid>
 </Border>
 </Grid>
 </ScrollViewer>

 <!-- Top center elements panel -->
 <Border x:Name="TopToolbar" Panel.ZIndex="10" HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,10,0,0" Padding="4" Style="{StaticResource OverlayPanelBorder}">
 <StackPanel Orientation="Horizontal">
 <Button Command="{Binding AddTextBlockCommand}" Style="{StaticResource ActionButtonStyle}" MinWidth="180" Margin="0,0,10,0">
 <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8D2;" Margin="0,0,8,0"/>
 <TextBlock Text="Добавить текст"/>
 </StackPanel>
 </Button>
 <Button Command="{Binding AddImageCommand}" Style="{StaticResource ActionButtonStyle}" MinWidth="200" Margin="0,0,0,0">
 <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8B8;" Margin="0,0,8,0"/>
 <TextBlock Text="Добавить изображение"/>
 </StackPanel>
 </Button>
 </StackPanel>
 </Border>

 <!-- Right properties panel (overlay) -->
 <Border x:Name="RightPanelBorder" Panel.ZIndex="20"
 HorizontalAlignment="Right" VerticalAlignment="Stretch" Margin="10" Padding="10"
 Style="{StaticResource OverlayPanelBorder}" MinWidth="380"
 Visibility="{Binding IsRightPanelOpen, Converter={StaticResource BoolToVis}}">
 <ScrollViewer VerticalScrollBarVisibility="Auto">
 <StackPanel>

 <!-- Canvas properties -->
 <StackPanel x:Name="CanvasProps" Margin="0,0,0,8" PreviewMouseLeftButtonDown="OnCanvasPropsClick">
 <StackPanel.Style>
 <Style TargetType="StackPanel">
 <Setter Property="Visibility" Value="Collapsed"/>
 <Style.Triggers>
 <DataTrigger Binding="{Binding IsCanvasPropertiesVisible}" Value="True">
 <Setter Property="Visibility" Value="Visible"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>
 </StackPanel.Style>
 <TextBlock Text="Свойства холста" Style="{StaticResource HeaderTextBlock}"/>
 <TextBlock Text="Название" Style="{StaticResource SubheaderTextBlock}"/>
 <TextBox Text="{Binding SelectedTemplateName, UpdateSourceTrigger=PropertyChanged}" Margin="0,2,0,0"/>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Ширина (мм)"/>
 <TextBox Grid.Column="1" Text="{Binding SelectedTemplateWidth, UpdateSourceTrigger=PropertyChanged}" Margin="0,2,0,0"/>
 </Grid>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Высота (мм)"/>
 <TextBox Grid.Column="1" Text="{Binding SelectedTemplateHeight, UpdateSourceTrigger=PropertyChanged}" Margin="0,2,0,0"/>
 </Grid>
 <TextBlock Text="Элементы на холсте" Style="{StaticResource SubheaderTextBlock}"/>
 <ListBox ItemsSource="{Binding SelectedTemplateItems}" SelectedItem="{Binding SelectedTemplateItem}" DisplayMemberPath="DisplayName" Height="180" Margin="0,4,0,0">
 <ListBox.ItemContainerStyle>
 <Style TargetType="ListBoxItem">
 <EventSetter Event="PreviewMouseLeftButtonDown" Handler="OnCanvasItemListClick"/>
 </Style>
 </ListBox.ItemContainerStyle>
 </ListBox>
 <TextBlock Text="Фон холста" Style="{StaticResource SubheaderTextBlock}" Margin="0,8,0,4"/>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 <ColumnDefinition Width="Auto"/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Файл"/>
 <Button Grid.Column="1" Content="Выбрать..." Width="120" HorizontalAlignment="Left" Command="{Binding ChangeBackgroundImageCommand}"/>
 <Button Grid.Column="2" Content="Удалить" Margin="8,0,0,0" Command="{Binding ClearBackgroundImageCommand}"/>
 </Grid>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Режим растяжения"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding StretchModes}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding CanvasBackgroundStretch, Mode=TwoWay}"/>
 </Grid>
 </StackPanel>

 <!-- Item properties (minimal) -->
 <StackPanel x:Name="ItemProps" DataContext="{Binding SelectedTemplateItem}" Margin="0,0,0,8">
 <StackPanel.Style>
 <Style TargetType="StackPanel">
 <Setter Property="Visibility" Value="Collapsed"/>
 <Style.Triggers>
 <DataTrigger Binding="{Binding DataContext.IsItemPropertiesVisible, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
 <Setter Property="Visibility" Value="Visible"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>
 </StackPanel.Style>

 <TextBlock Text="Свойства элемента" Style="{StaticResource HeaderTextBlock}"/>

 <!-- Привязка к полю (только для текста) -->
 <StackPanel x:Name="BindingSelector" Visibility="{Binding IsImage, Converter={StaticResource InverseBoolToVis}}" Margin="0,6,0,6">
 <TextBlock Text="Привязка к полю получателя" Style="{StaticResource SubheaderTextBlock}"/>
 <DockPanel>
 <ComboBox Width="220" ItemsSource="{Binding DataContext.AvailableRecipientColumns, RelativeSource={RelativeSource AncestorType=UserControl}}"
 SelectedItem="{Binding ContentBindingPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Margin="0,2,0,0"/>
 <Button Content="Отвяжите" Margin="6,2,0,0" Command="{Binding DataContext.UnbindSelectedItemCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
 </DockPanel>
 </StackPanel>

 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Название"/>
 <TextBox Grid.Column="1" Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Margin="0,2,0,0"/>
 </Grid>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Слой (0-10)"/>
 <TextBox Grid.Column="1" Text="{Binding ZIndex, UpdateSourceTrigger=PropertyChanged}" Margin="0,2,0,0"/>
 </Grid>

 <!-- Блок настроек текста (если это не изображение) -->
 <StackPanel x:Name="TextFormatting" Visibility="{Binding IsImage, Converter={StaticResource InverseBoolToVis}}" Margin="0,8,0,0">
 <TextBlock Text="Текст" Style="{StaticResource SubheaderTextBlock}"/>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Текст элемента"/>
 <TextBox Grid.Column="1" Text="{Binding StaticText, UpdateSourceTrigger=PropertyChanged}" Margin="0,2,0,0"/>
 </Grid>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Шрифт"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.FontFamilies, RelativeSource={RelativeSource AncestorType=UserControl}}" SelectedItem="{Binding FontFamily}" Margin="0,2,0,0"/>
 </Grid>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Размер"/>
 <TextBox Grid.Column="1" Text="{Binding FontSize, UpdateSourceTrigger=PropertyChanged}" Margin="0,2,0,0"/>
 </Grid>
 <StackPanel Orientation="Horizontal" Margin="6,4,6,0">
 <CheckBox Content="Жирный" IsChecked="{Binding IsBold}" Margin="0,0,12,0"/>
 <CheckBox Content="Курсив" IsChecked="{Binding IsItalic}"/>
 </StackPanel>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Выравнивание текста"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.TextAlignments, RelativeSource={RelativeSource AncestorType=UserControl}}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding TextAlignmentString, Mode=TwoWay}" Margin="0,2,0,0"/>
 </Grid>
 </StackPanel>

 <!-- Цвета и фон -->
 <Grid Style="{StaticResource LabeledRowGrid}" Visibility="{Binding IsImage, Converter={StaticResource InverseBoolToVis}}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 <ColumnDefinition Width='Auto'/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Цвет текста"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.ColorChoices, RelativeSource={RelativeSource AncestorType=UserControl}}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding ForegroundChoice, Mode=TwoWay}" Margin="0,2,0,0"/>
 <Button Grid.Column="2" Content="Палитра..." Margin="8,2,0,0" Tag="ForegroundString" Click="OnPickColorClick"/>
 </Grid>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 <ColumnDefinition Width='Auto'/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Фон"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.ColorChoices, RelativeSource={RelativeSource AncestorType=UserControl}}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding BackgroundChoice, Mode=TwoWay}" Margin="0,2,0,0"/>
 <Button Grid.Column="2" Content="Палитра..." Margin="8,2,0,0" Tag="BackgroundString" Click="OnPickColorClick"/>
 </Grid>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 <ColumnDefinition Width='Auto'/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Граница"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.ColorChoices, RelativeSource={RelativeSource AncestorType=UserControl}}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding BorderBrushChoice, Mode=TwoWay}" Margin="0,2,0,0"/>
 <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="8,0,0,0" VerticalAlignment="Center">
 <Button Content="Цвет..." Tag="BorderBrushString" Click="OnPickColorClick"/>
 <TextBlock Text="Толщина" Margin="8,0,6,0" VerticalAlignment="Center"/>
 <!-- Thickness preset selector -->
 <ComboBox Width="80" SelectedValuePath="Tag" SelectedValue="{Binding BorderThickness, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
 <ComboBoxItem Content="0"><ComboBoxItem.Tag><sys:Double>0</sys:Double></ComboBoxItem.Tag></ComboBoxItem>
 <ComboBoxItem Content="0,5"><ComboBoxItem.Tag><sys:Double>0.5</sys:Double></ComboBoxItem.Tag></ComboBoxItem>
 <ComboBoxItem Content="1"><ComboBoxItem.Tag><sys:Double>1</sys:Double></ComboBoxItem.Tag></ComboBoxItem>
 <ComboBoxItem Content="2"><ComboBoxItem.Tag><sys:Double>2</sys:Double></ComboBoxItem.Tag></ComboBoxItem>
 <ComboBoxItem Content="3"><ComboBoxItem.Tag><sys:Double>3</sys:Double></ComboBoxItem.Tag></ComboBoxItem>
 <ComboBoxItem Content="4"><ComboBoxItem.Tag><sys:Double>4</sys:Double></ComboBoxItem.Tag></ComboBoxItem>
 </ComboBox>
 </StackPanel>
 </Grid>

 <!-- Скругление, отступы и выравнивание элемента -->
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Скругление углов"/>
 <ComboBox Grid.Column="1" SelectedValue="{Binding CornerRadiusValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" SelectedValuePath="Tag" Margin="0,2,0,0">
 <ComboBoxItem Content="0" Tag="0"/>
 <ComboBoxItem Content="2" Tag="2"/>
 <ComboBoxItem Content="4" Tag="4"/>
 <ComboBoxItem Content="6" Tag="6"/>
 <ComboBoxItem Content="8" Tag="8"/>
 </ComboBox>
 </Grid>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Внутренний отступ"/>
 <!-- Uniform padding presets as doubles -->
 <ComboBox Grid.Column="1" SelectedValuePath="Tag" SelectedValue="{Binding Padding, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Margin="0,2,0,0">
 <ComboBoxItem Content="0"><ComboBoxItem.Tag><sys:Double>0</sys:Double></ComboBoxItem.Tag></ComboBoxItem>
 <ComboBoxItem Content="2"><ComboBoxItem.Tag><sys:Double>2</sys:Double></ComboBoxItem.Tag></ComboBoxItem>
 <ComboBoxItem Content="4"><ComboBoxItem.Tag><sys:Double>4</sys:Double></ComboBoxItem.Tag></ComboBoxItem>
 <ComboBoxItem Content="6"><ComboBoxItem.Tag><sys:Double>6</sys:Double></ComboBoxItem.Tag></ComboBoxItem>
 <ComboBoxItem Content="8"><ComboBoxItem.Tag><sys:Double>8</sys:Double></ComboBoxItem.Tag></ComboBoxItem>
 <ComboBoxItem Content="10"><ComboBoxItem.Tag><sys:Double>10</sys:Double></ComboBoxItem.Tag></ComboBoxItem>
 <ComboBoxItem Content="12"><ComboBoxItem.Tag><sys:Double>12</sys:Double></ComboBoxItem.Tag></ComboBoxItem>
 </ComboBox>
 </Grid>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Горизонтальное выравнивание"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.HorizontalAlignments, RelativeSource={RelativeSource AncestorType=UserControl}}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding HorizontalAlignmentString, Mode=TwoWay}" Margin="0,2,0,0"/>
 </Grid>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Вертикальное выравнивание"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.VerticalAlignments, RelativeSource={RelativeSource AncestorType=UserControl}}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding VerticalAlignmentString, Mode=TwoWay}" Margin="0,2,0,0"/>
 </Grid>
 </StackPanel>

 <!-- Настройки изображения (если это изображение) -->
 <StackPanel x:Name="ImageSettings" DataContext="{Binding SelectedTemplateItem}" Margin="0,8,0,0">
 <StackPanel.Style>
 <Style TargetType="StackPanel">
 <Setter Property="Visibility" Value="Collapsed"/>
 <Style.Triggers>
 <MultiDataTrigger>
 <MultiDataTrigger.Conditions>
 <Condition Binding="{Binding DataContext.IsItemPropertiesVisible, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True"/>
 <Condition Binding="{Binding IsImage}" Value="True"/>
 </MultiDataTrigger.Conditions>
 <Setter Property="Visibility" Value="Visible"/>
 </MultiDataTrigger>
 </Style.Triggers>
 </Style>
 </StackPanel.Style>
 <TextBlock Text="Настройки изображения" Style="{StaticResource SubheaderTextBlock}"/>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Файл"/>
 <Button Grid.Column="1" Content="Выбрать..." Width="120" HorizontalAlignment="Left" Command="{Binding DataContext.ChangeImageCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
 </Grid>
 <Grid Style="{StaticResource LabeledRowGrid}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Режим растяжения"/>
 <ComboBox Grid.Column="1" ItemsSource="{Binding DataContext.StretchModes, RelativeSource={RelativeSource AncestorType=UserControl}}" DisplayMemberPath="Display" SelectedValuePath="Value" SelectedValue="{Binding StretchString, Mode=TwoWay}" Margin="0,2,0,0"/>
 </Grid>
 <!-- Hide text-related color row inside image properties -->
 <Grid Style="{StaticResource LabeledRowGrid}" Visibility="Collapsed">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Цвет текста"/>
 <ComboBox Grid.Column="1"/>
 </Grid>
 </StackPanel>

 <!-- Общие настройки (только для выбранного элемента, не для холста) -->
 <StackPanel>
 <StackPanel.Style>
 <Style TargetType="StackPanel">
 <Setter Property="Visibility" Value="Collapsed"/>
 <Style.Triggers>
 <DataTrigger Binding="{Binding DataContext.IsItemPropertiesVisible, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
 <Setter Property="Visibility" Value="Visible"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>
 </StackPanel.Style>
 <Grid Style="{StaticResource LabeledRowGrid}" DataContext="{Binding SelectedTemplateItem}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Прозрачность"/>
 <Slider Grid.Column="1" Minimum="0" Maximum="1" SmallChange="0.01" LargeChange="0.1" TickFrequency="0.1" IsSnapToTickEnabled="False" Value="{Binding Opacity, Mode=TwoWay}"/>
 </Grid>
 <Grid Style="{StaticResource LabeledRowGrid}" Margin="6,4,6,0" DataContext="{Binding SelectedTemplateItem}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition/>
 <ColumnDefinition/>
 </Grid.ColumnDefinitions>
 <TextBlock Text="Поворот (°)"/>
 <TextBox Grid.Column="1" Text="{Binding RotationDegrees, UpdateSourceTrigger=PropertyChanged}" Margin="0,2,0,0"/>
 </Grid>
 </StackPanel>
 <!-- Прозрачность и поворот скрыты, когда элемент не выбран (для холста не применяются) -->
 </StackPanel>
 </ScrollViewer>
 </Border>

 <!-- Left overlay panel -->
 <Border x:Name="LeftOverlayPanel" Panel.ZIndex="20" HorizontalAlignment="Left" VerticalAlignment="Stretch" Margin="12" Padding="10" Style="{StaticResource OverlayPanelBorder}"
 Visibility="{Binding IsLeftPanelVisible, Converter={StaticResource BoolToVis}}">
 <StackPanel>
 <TextBlock Text="Холсты" Style="{StaticResource HeaderTextBlock}"/>
 <StackPanel Orientation="Horizontal" Margin="0,6,0,8" HorizontalAlignment="Left">
 <Button Content="Новый" Command="{Binding AddTemplateCommand}" Style="{StaticResource ActionButtonStyle}" MinWidth="120" Height="32"/>
 <Button Content="Удалить" Margin="6,0,0,0" Command="{Binding RemoveTemplateCommand}" Style="{StaticResource ActionButtonStyle}" MinWidth="120" Height="32"/>
 </StackPanel>
 <Border Style="{StaticResource PanelBorder}" Padding="4" Margin="0,0,0,4">
 <ListBox ItemsSource="{Binding Templates}" SelectedItem="{Binding SelectedTemplate}"
 Height="220"
 ScrollViewer.CanContentScroll="True"
 VirtualizingPanel.IsVirtualizing="True"
 VirtualizingPanel.VirtualizationMode="Recycling"
 VirtualizingPanel.ScrollUnit="Pixel"
 Background="Transparent"
 BorderThickness="0">
 <ListBox.ItemContainerStyle>
 <Style TargetType="ListBoxItem">
 <Setter Property="Margin" Value="4,4,4,0"/>
 <Setter Property="Padding" Value="6"/>
 <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="ListBoxItem">
 <Border x:Name="Bd" Background="Transparent" CornerRadius="6" Padding="6">
 <ContentPresenter/>
 </Border>
 <ControlTemplate.Triggers>
 <Trigger Property="IsSelected" Value="True">
 <Setter TargetName="Bd" Property="Background" Value="#0F0078D4"/>
 <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource SelectionBrush}"/>
 <Setter TargetName="Bd" Property="BorderThickness" Value="1"/>
 </Trigger>
 <Trigger Property="IsMouseOver" Value="True">
 <Setter TargetName="Bd" Property="Background" Value="#0A000000"/>
 </Trigger>
 </ControlTemplate.Triggers>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>
 </ListBox.ItemContainerStyle>
 <ListBox.ItemTemplate>
 <DataTemplate>
 <TextBlock Text="{Binding Name}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis" Margin="4,4,6,4">
 <TextBlock.Style>
 <Style TargetType="TextBlock">
 <Setter Property="FontSize" Value="14"/>
 <Style.Triggers>
 <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="True">
 <Setter Property="FontSize" Value="16"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>
 </TextBlock.Style>
 </TextBlock>
 </DataTemplate>
 </ListBox.ItemTemplate>
 </ListBox>
 </Border>
 </StackPanel>
 </Border>

 <!-- Bottom overlay -->
 <StackPanel Orientation="Horizontal" Panel.ZIndex="10" HorizontalAlignment="Center" VerticalAlignment="Bottom" Margin="0,0,0,10">
 <Border x:Name="ZoomPanelBorder" Padding="6" Style="{StaticResource OverlayPanelBorder}">
 <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
 <Button Style="{StaticResource FileButtonStyle}" Content="-" Command="{Binding ZoomOutCommand}" MinWidth="44" Padding="12,4"/>
 <Button x:Name="ZoomPercentButton" Style="{StaticResource FileButtonStyle}" Command="{Binding ResetZoomCommand}" MinWidth="64" Padding="16,4" PreviewMouseRightButtonUp="OnZoomPercentRightClick" Margin="8,0,8,0">
 <TextBlock Text="{Binding ZoomPercentage, StringFormat={}{0}%}"/>
 </Button>
 <Button Style="{StaticResource FileButtonStyle}" Content="+" Command="{Binding ZoomInCommand}" MinWidth="44" Padding="12,4"/>
 </StackPanel>
 </Border>
 <Border Margin="10,0,0,0" Padding="4" Style="{StaticResource OverlayPanelBorder}">
 <StackPanel Orientation="Horizontal">
 <Button Command="{Binding PreviewCommand}" Style="{StaticResource ActionButtonStyle}" MinWidth="160" Margin="0,0,8,0">
 <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8A1;" Margin="0,0,8,0"/>
 <TextBlock Text="Предпросмотр"/>
 </StackPanel>
 </Button>
 <Button Command="{Binding SaveChangesCommand}" Style="{StaticResource ActionButtonStyle}" MinWidth="160">
 <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE74E;" Margin="0,0,8,0"/>
 <TextBlock Text="Сохранить"/>
 </StackPanel>
 </Button>
 </StackPanel>
 </Border>
 </StackPanel>

 <!-- Left panel toggle -->
 <ToggleButton x:Name="ArrowToggle" Panel.ZIndex="21" HorizontalAlignment="Left" VerticalAlignment="Bottom" Margin="10,0,0,18" Style="{StaticResource FloatingArrowButtonStyle}" IsChecked="{Binding IsLeftPanelVisible, Mode=TwoWay}" Click="OnArrowToggleClick">
 <ToggleButton.RenderTransform>
 <TranslateTransform X="-8"/>
 </ToggleButton.RenderTransform>
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE76C;"/>
 </ToggleButton>

 <!-- Zoom popup -->
 <Popup x:Name="ZoomPopup" Placement="Top" PlacementTarget="{Binding ElementName=ZoomPanelBorder}" StaysOpen="False" AllowsTransparency="True" PopupAnimation="Fade">
 <Border x:Name="ZoomPopupContent" Style="{StaticResource OverlayPanelBorder}" Padding="8" MinHeight="44">
 <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
 <Slider Width="240" Minimum="20" Maximum="200" Value="{Binding ZoomPercentage, Mode=TwoWay}" TickFrequency="10" IsSnapToTickEnabled="True"/>
 </StackPanel>
 </Border>
 </Popup>
 </Grid>
</UserControl>