<UserControl x:Class="Envelope_printing.RecipientEditorView"
 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
 xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
 xmlns:local="clr-namespace:Envelope_printing"
 mc:Ignorable="d" 
 d:DesignHeight="500" d:DesignWidth="700">

 <!-- Горячие клавиши для действий -->
 <UserControl.InputBindings>
 <KeyBinding Key="N" Modifiers="Control" Command="{Binding AddCommand}"/>
 <KeyBinding Key="F2" Command="{Binding EditCommand}"/>
 <KeyBinding Key="Delete" Command="{Binding DeleteCommand}"/>
 <KeyBinding Key="F" Modifiers="Control" Command="{Binding ShowSearchCommand}"/>
 <KeyBinding Key="Escape" Command="{Binding CloseSearchCommand}"/>
 <KeyBinding Key="Up" Command="{Binding SelectPreviousRowCommand}"/>
 <KeyBinding Key="Down" Command="{Binding SelectNextRowCommand}"/>
 </UserControl.InputBindings>

 <UserControl.Resources>
 <BooleanToVisibilityConverter x:Key="BoolToVis"/>
 <local:LessThanConverter x:Key="LessThanConverter"/>

 <!-- Стиль для кнопки "Файл" -->
 <Style x:Key="FileButtonStyle" TargetType="Button">
 <Setter Property="Background" Value="Transparent"/>
 <Setter Property="BorderThickness" Value="1"/>
 <Setter Property="Width" Value="60"/>
 <Setter Property="Height" Value="26"/>
 <Setter Property="Margin" Value="2,0"/>
 <Setter Property="Cursor" Value="Hand"/>
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="Button">
 <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="4" BorderBrush="Transparent" BorderThickness="1">
 <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
 </Border>
 <ControlTemplate.Triggers>
 <Trigger Property="IsMouseOver" Value="True">
 <Setter TargetName="border" Property="Background" Value="#EAF2FA"/>
 <Setter TargetName="border" Property="BorderBrush" Value="#D0D8E0"/>
 </Trigger>
 <Trigger Property="IsPressed" Value="True">
 <Setter TargetName="border" Property="Background" Value="#DCE9F7"/>
 </Trigger>
 </ControlTemplate.Triggers>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>

 <!-- Стиль для кнопок на плавающей панели -->
 <Style x:Key="ActionButtonStyle" TargetType="Button">
 <Setter Property="Background" Value="White"/>
 <Setter Property="BorderBrush" Value="#D0D0D0"/>
 <Setter Property="BorderThickness" Value="1"/>
 <Setter Property="Padding" Value="12,0"/>
 <Setter Property="MinHeight" Value="40"/>
 <Setter Property="MinWidth" Value="140"/>
 <Setter Property="Margin" Value="4"/>
 <Setter Property="Cursor" Value="Hand"/>
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="Button">
 <Border Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="4">
 <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
 </Border>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 <Style.Triggers>
 <Trigger Property="IsMouseOver" Value="True">
 <Setter Property="Background" Value="#F0F8FF"/>
 </Trigger>
 <Trigger Property="IsPressed" Value="True">
 <Setter Property="Background" Value="#E0F0FF"/>
 </Trigger>
 <Trigger Property="IsEnabled" Value="False">
 <Setter Property="Opacity" Value="0.6"/>
 </Trigger>
 <DataTrigger Binding="{Binding Path=ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThanConverter}, ConverterParameter=850}" Value="True">
 <Setter Property="MinWidth" Value="44"/>
 </DataTrigger>
 <DataTrigger Binding="{Binding Path=ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThanConverter}, ConverterParameter=850}" Value="False">
 <Setter Property="MinWidth" Value="140"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>

 <!-- Компактные икон-кнопки для панели поиска -->
 <Style x:Key="SearchIconButtonStyle" TargetType="Button">
 <Setter Property="Width" Value="32"/>
 <Setter Property="Height" Value="32"/>
 <Setter Property="Background" Value="Transparent"/>
 <Setter Property="BorderBrush" Value="Transparent"/>
 <Setter Property="BorderThickness" Value="1"/>
 <Setter Property="Padding" Value="0"/>
 <Setter Property="Cursor" Value="Hand"/>
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="Button">
 <Border x:Name="root" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="4">
 <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
 </Border>
 <ControlTemplate.Triggers>
 <Trigger Property="IsMouseOver" Value="True">
 <Setter TargetName="root" Property="Background" Value="#F3F6FA"/>
 <Setter TargetName="root" Property="BorderBrush" Value="#C8D0D8"/>
 </Trigger>
 <Trigger Property="IsPressed" Value="True">
 <Setter TargetName="root" Property="Background" Value="#E6EEF9"/>
 </Trigger>
 </ControlTemplate.Triggers>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>

 <!-- Кнопка закрытия поиска с более явным фоном -->
 <Style x:Key="SearchCloseButtonStyle" BasedOn="{StaticResource SearchIconButtonStyle}" TargetType="Button">
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="Button">
 <Border x:Name="root" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="4">
 <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
 </Border>
 <ControlTemplate.Triggers>
 <Trigger Property="IsMouseOver" Value="True">
 <Setter TargetName="root" Property="Background" Value="#FFEBEE"/>
 <Setter TargetName="root" Property="BorderBrush" Value="#EF9A9A"/>
 </Trigger>
 <Trigger Property="IsPressed" Value="True">
 <Setter TargetName="root" Property="Background" Value="#FFCDD2"/>
 </Trigger>
 </ControlTemplate.Triggers>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>

 <!-- Цвет подсветки выбранной строки, которая также является совпадением поиска -->
 <SolidColorBrush x:Key="SelectedMatchBrush" Color="#FFE0A3"/>
 </UserControl.Resources>

 <Grid>
 <Grid>
 <Grid.RowDefinitions>
 <RowDefinition Height="Auto"/>
 <RowDefinition Height="Auto"/>
 <RowDefinition Height="*"/>
 </Grid.RowDefinitions>

 <!-- Верхняя панель с кнопкой Файл -->
 <Border Grid.Row="0" Background="#F8F9FA" BorderBrush="#E1E4E8" BorderThickness="0,0,0,1" Padding="4" CornerRadius="6,6,6,6" Margin="5,0,5,0">
 <StackPanel Orientation="Horizontal">
 <Button Style="{StaticResource FileButtonStyle}" ToolTip="Импорт, Экспорт, Резервное копирование">
 <StackPanel Orientation="Horizontal">
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE713;" VerticalAlignment="Center"/>
 <TextBlock Text="Файл" Margin="6,0,0,0"/>
 </StackPanel>
 <Button.ContextMenu>
 <ContextMenu>
 <MenuItem Header="Импорт из Excel" Command="{Binding ImportFromExcelCommand}"/>
 <MenuItem Header="Экспорт в Excel" Command="{Binding ExportToExcelCommand}"/>
 <Separator/>
 <MenuItem Header="Создать резервную копию" Command="{Binding BackupCommand}"/>
 <MenuItem Header="Восстановить из копии" Command="{Binding RestoreCommand}"/>
 </ContextMenu>
 </Button.ContextMenu>
 </Button>
 </StackPanel>
 </Border>

 <!-- Поисковая панель (компактная, слева и по содержимому) -->
 <Border Grid.Row="1" Background="#FFF8E1" BorderBrush="#FFC107" BorderThickness="0,1,0,1"
 Visibility="{Binding IsSearchVisible, Converter={StaticResource BoolToVis}}" CornerRadius="4" Margin="5,4,5,0" HorizontalAlignment="Left">
 <Grid Margin="4">
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="Auto"/>
 </Grid.ColumnDefinitions>

 <!-- Поле поиска с иконкой -->
 <Border Grid.Column="0" Background="White" BorderBrush="LightGray" BorderThickness="1" CornerRadius="3" Padding="4,1" VerticalAlignment="Center">
 <Grid>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="200"/>
 </Grid.ColumnDefinitions>
 <TextBlock Grid.Column="0" FontFamily="Segoe MDL2 Assets" Text="&#xE721;" Foreground="#7A7A7A" VerticalAlignment="Center" Margin="2,0,6,0"/>
 <TextBox Grid.Column="1" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" VerticalContentAlignment="Center" BorderThickness="0" Background="Transparent"/>
 </Grid>
 </Border>

 <TextBlock Grid.Column="1" Text="{Binding MatchInfo}" Margin="8,0" VerticalAlignment="Center" Foreground="Gray" MinWidth="100" TextAlignment="Right"/>

 <!-- Навигация по результатам поиска -->
 <Button Grid.Column="2" Style="{StaticResource SearchIconButtonStyle}" Command="{Binding PreviousMatchCommand}" ToolTip="Предыдущее совпадение">
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE76B;"/>
 </Button>
 <Button Grid.Column="3" Style="{StaticResource SearchIconButtonStyle}" Command="{Binding NextMatchCommand}" ToolTip="Следующее совпадение" Margin="4,0,0,0">
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE76C;"/>
 </Button>

 <!-- Закрыть поиск -->
 <Button Grid.Column="4" Style="{StaticResource SearchCloseButtonStyle}" Command="{Binding CloseSearchCommand}" ToolTip="Закрыть поиск (Esc)" Margin="8,0,0,0">
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE711;" FontSize="14"/>
 </Button>
 </Grid>
 </Border>

 <!-- Таблица -->
 <DataGrid x:Name="RecipientsGrid" Grid.Row="2" Margin="5" ItemsSource="{Binding RecipientsCollection}" SelectedItem="{Binding SelectedRecipient, Mode=TwoWay}" AutoGenerateColumns="False" IsReadOnly="True" SelectionMode="Single" ContextMenuOpening="RecipientsGrid_ContextMenuOpening">
 <DataGrid.ContextMenu>
 <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
 <MenuItem Header="Редактировать" Command="{Binding EditCommand}"/>
 <MenuItem Header="Удалить" Command="{Binding DeleteCommand}"/>
 </ContextMenu>
 </DataGrid.ContextMenu>
 <DataGrid.RowStyle>
 <Style TargetType="DataGridRow">
 <Style.Triggers>
 <!-- Совпадение поиска -->
 <DataTrigger Binding="{Binding IsMatch}" Value="True">
 <Setter Property="Background" Value="#FFF9C4"/>
 </DataTrigger>
 <!-- Обычное выделение -->
 <Trigger Property="IsSelected" Value="True">
 <Setter Property="Background" Value="#0078D7"/>
 <Setter Property="Foreground" Value="White"/>
 </Trigger>
 <!-- Если строка и выбрана, и совпала: отдельный цвет -->
 <MultiDataTrigger>
 <MultiDataTrigger.Conditions>
 <Condition Binding="{Binding IsMatch}" Value="True"/>
 <Condition Binding="{Binding RelativeSource={RelativeSource Self}, Path=IsSelected}" Value="True"/>
 </MultiDataTrigger.Conditions>
 <Setter Property="Background" Value="{StaticResource SelectedMatchBrush}"/>
 <Setter Property="Foreground" Value="Black"/>
 </MultiDataTrigger>
 </Style.Triggers>
 </Style>
 </DataGrid.RowStyle>
 <DataGrid.Columns>
 <DataGridTextColumn Header="Учреждение" Binding="{Binding OrganizationName}" Width="2*"/>
 <DataGridTextColumn Header="Улица" Binding="{Binding AddressLine1}" Width="3*"/>
 <DataGridTextColumn Header="Индекс" Binding="{Binding PostalCode}" Width="*"/>
 <DataGridTextColumn Header="Город" Binding="{Binding City}" Width="*"/>
 <DataGridTextColumn Header="Область" Binding="{Binding Region}" Width="*"/>
 <DataGridTextColumn Header="Страна" Binding="{Binding Country}" Width="*"/>
 </DataGrid.Columns>
 </DataGrid>
 </Grid>

 <!-- Слой2: Плавающая панель действий (снизу) -->
 <Border HorizontalAlignment="Center" VerticalAlignment="Bottom" Panel.ZIndex="100" Margin="0,0,0,12">
 <Border Background="White" BorderBrush="Gainsboro" BorderThickness="1" CornerRadius="6" Padding="6">
 <Border.Effect>
 <DropShadowEffect ShadowDepth="3" Color="Gray" Opacity="0.3" BlurRadius="6"/>
 </Border.Effect>
 <WrapPanel>
 <!-- Добавить -->
 <Button Style="{StaticResource ActionButtonStyle}" Command="{Binding AddCommand}" ToolTip="Добавить новую запись (Ctrl+N)">
 <Grid>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="*"/>
 </Grid.ColumnDefinitions>
 <TextBlock Grid.Column="0" FontFamily="Segoe MDL2 Assets" Text="&#xE710;" VerticalAlignment="Center"/>
 <TextBlock Grid.Column="1" Text="Добавить" Margin="8,0,0,0">
 <TextBlock.Style>
 <Style TargetType="TextBlock">
 <Style.Triggers>
 <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThanConverter}, ConverterParameter=850}" Value="True">
 <Setter Property="Visibility" Value="Collapsed"/>
 </DataTrigger>
 <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThanConverter}, ConverterParameter=850}" Value="False">
 <Setter Property="Visibility" Value="Visible"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>
 </TextBlock.Style>
 </TextBlock>
 </Grid>
 </Button>

 <!-- Редактировать -->
 <Button Style="{StaticResource ActionButtonStyle}" Command="{Binding EditCommand}" ToolTip="Редактировать выбранное (F2)">
 <Grid>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="*"/>
 </Grid.ColumnDefinitions>
 <TextBlock Grid.Column="0" FontFamily="Segoe MDL2 Assets" Text="&#xE70F;" VerticalAlignment="Center"/>
 <TextBlock Grid.Column="1" Text="Редактировать" Margin="8,0,0,0">
 <TextBlock.Style>
 <Style TargetType="TextBlock">
 <Style.Triggers>
 <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThanConverter}, ConverterParameter=850}" Value="True">
 <Setter Property="Visibility" Value="Collapsed"/>
 </DataTrigger>
 <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThanConverter}, ConverterParameter=850}" Value="False">
 <Setter Property="Visibility" Value="Visible"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>
 </TextBlock.Style>
 </TextBlock>
 </Grid>
 </Button>

 <!-- Удалить -->
 <Button Style="{StaticResource ActionButtonStyle}" Command="{Binding DeleteCommand}" ToolTip="Удалить выбранное (Del)">
 <Grid>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="*"/>
 </Grid.ColumnDefinitions>
 <TextBlock Grid.Column="0" FontFamily="Segoe MDL2 Assets" Text="&#xE74D;" VerticalAlignment="Center"/>
 <TextBlock Grid.Column="1" Text="Удалить" Margin="8,0,0,0">
 <TextBlock.Style>
 <Style TargetType="TextBlock">
 <Style.Triggers>
 <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThanConverter}, ConverterParameter=850}" Value="True">
 <Setter Property="Visibility" Value="Collapsed"/>
 </DataTrigger>
 <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThanConverter}, ConverterParameter=850}" Value="False">
 <Setter Property="Visibility" Value="Visible"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>
 </TextBlock.Style>
 </TextBlock>
 </Grid>
 </Button>

 <!-- Найти -->
 <Button Style="{StaticResource ActionButtonStyle}" Command="{Binding ShowSearchCommand}" ToolTip="Найти в таблице (Ctrl+F)">
 <Grid>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="*"/>
 </Grid.ColumnDefinitions>
 <TextBlock Grid.Column="0" FontFamily="Segoe MDL2 Assets" Text="&#xE721;" VerticalAlignment="Center"/>
 <TextBlock Grid.Column="1" Text="Найти" Margin="8,0,0,0">
 <TextBlock.Style>
 <Style TargetType="TextBlock">
 <Style.Triggers>
 <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThanConverter}, ConverterParameter=850}" Value="True">
 <Setter Property="Visibility" Value="Collapsed"/>
 </DataTrigger>
 <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThanConverter}, ConverterParameter=850}" Value="False">
 <Setter Property="Visibility" Value="Visible"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>
 </TextBlock.Style>
 </TextBlock>
 </Grid>
 </Button>

 <!-- Вверх: перемещаем фокус, не строки -->
 <Button Style="{StaticResource ActionButtonStyle}" Command="{Binding SelectPreviousRowCommand}" ToolTip="Перейти к предыдущей строке">
 <Grid>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="*"/>
 </Grid.ColumnDefinitions>
 <TextBlock Grid.Column="0" FontFamily="Segoe MDL2 Assets" Text="&#xE70E;" VerticalAlignment="Center"/>
 <TextBlock Grid.Column="1" Text="Вверх" Margin="8,0,0,0">
 <TextBlock.Style>
 <Style TargetType="TextBlock">
 <Style.Triggers>
 <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThanConverter}, ConverterParameter=850}" Value="True">
 <Setter Property="Visibility" Value="Collapsed"/>
 </DataTrigger>
 <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThanConverter}, ConverterParameter=850}" Value="False">
 <Setter Property="Visibility" Value="Visible"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>
 </TextBlock.Style>
 </TextBlock>
 </Grid>
 </Button>

 <!-- Вниз: перемещаем фокус, не строки -->
 <Button Style="{StaticResource ActionButtonStyle}" Command="{Binding SelectNextRowCommand}" ToolTip="Перейти к следующей строке">
 <Grid>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="*"/>
 </Grid.ColumnDefinitions>
 <TextBlock Grid.Column="0" FontFamily="Segoe MDL2 Assets" Text="&#xE70D;" VerticalAlignment="Center"/>
 <TextBlock Grid.Column="1" Text="Вниз" Margin="8,0,0,0">
 <TextBlock.Style>
 <Style TargetType="TextBlock">
 <Style.Triggers>
 <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThanConverter}, ConverterParameter=850}" Value="True">
 <Setter Property="Visibility" Value="Collapsed"/>
 </DataTrigger>
 <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThanConverter}, ConverterParameter=850}" Value="False">
 <Setter Property="Visibility" Value="Visible"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>
 </TextBlock.Style>
 </TextBlock>
 </Grid>
 </Button>
 </WrapPanel>
 </Border>
 </Border>
 </Grid>
</UserControl>