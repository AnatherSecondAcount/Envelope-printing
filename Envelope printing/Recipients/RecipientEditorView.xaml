<?xml version="1.0" encoding="utf-8"?>
<UserControl x:Class="Envelope_printing.RecipientEditorView"
 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
 xmlns:local="clr-namespace:Envelope_printing"
 xmlns:designer="clr-namespace:Envelope_printing.Designer"
 mc:Ignorable="d"
 d:DesignHeight="500" d:DesignWidth="700">

 <!-- Hotkeys -->
 <UserControl.InputBindings>
 <KeyBinding Key="N" Modifiers="Control" Command="{Binding AddCommand}"/>
 <KeyBinding Key="F2" Command="{Binding EditCommand}"/>
 <KeyBinding Key="Delete" Command="{Binding DeleteCommand}"/>
 <KeyBinding Key="F" Modifiers="Control" Command="{Binding ShowSearchCommand}"/>
 <KeyBinding Key="Escape" Command="{Binding CloseSearchCommand}"/>
 <KeyBinding Key="Up" Command="{Binding SelectPreviousRowCommand}"/>
 <KeyBinding Key="Down" Command="{Binding SelectNextRowCommand}"/>
 </UserControl.InputBindings>

 <UserControl.Resources>
 <BooleanToVisibilityConverter x:Key="BoolToVis"/>
 <local:LessThanConverter x:Key="LessThan"/>

 <!-- Local styles for search toolbar buttons -->
 <Style x:Key="SearchIconButtonStyle" TargetType="Button">
 <Setter Property="Width" Value="32"/>
 <Setter Property="Height" Value="32"/>
 <Setter Property="Background" Value="Transparent"/>
 <Setter Property="BorderBrush" Value="Transparent"/>
 <Setter Property="BorderThickness" Value="1"/>
 <Setter Property="Padding" Value="0"/>
 <Setter Property="Cursor" Value="Hand"/>
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="Button">
 <Border x:Name="root" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="4">
 <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
 </Border>
 <ControlTemplate.Triggers>
 <Trigger Property="IsMouseOver" Value="True">
 <Setter TargetName="root" Property="Background" Value="{DynamicResource ButtonHoverBrush}"/>
 <Setter TargetName="root" Property="BorderBrush" Value="{DynamicResource FieldBorderBrush}"/>
 </Trigger>
 <Trigger Property="IsPressed" Value="True">
 <Setter TargetName="root" Property="Background" Value="{DynamicResource ButtonPressedBrush}"/>
 </Trigger>
 </ControlTemplate.Triggers>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>

 <Style x:Key="SearchCloseButtonStyle" BasedOn="{StaticResource SearchIconButtonStyle}" TargetType="Button">
 <Setter Property="Template">
 <Setter.Value>
 <ControlTemplate TargetType="Button">
 <Border x:Name="root" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="4">
 <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
 </Border>
 <ControlTemplate.Triggers>
 <Trigger Property="IsMouseOver" Value="True">
 <Setter TargetName="root" Property="Background" Value="#FFEBEE"/>
 <Setter TargetName="root" Property="BorderBrush" Value="#EF9A9A"/>
 </Trigger>
 <Trigger Property="IsPressed" Value="True">
 <Setter TargetName="root" Property="Background" Value="#FFCDD2"/>
 </Trigger>
 </ControlTemplate.Triggers>
 </ControlTemplate>
 </Setter.Value>
 </Setter>
 </Style>

 <!-- Action bar button (spacing + responsive square mode) -->
 <Style x:Key="ActionBarButtonStyle" TargetType="Button" BasedOn="{StaticResource ActionButtonStyle}">
 <Setter Property="Margin" Value="6,0"/>
 <Setter Property="MinHeight" Value="40"/>
 <Setter Property="MinWidth" Value="140"/>
 <Style.Triggers>
 <!-- If control is narrow, shrink width and keep only icon -->
 <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThan}, ConverterParameter=760}" Value="True">
 <Setter Property="Width" Value="40"/>
 <Setter Property="MinWidth" Value="40"/>
 <Setter Property="Padding" Value="0"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>

 <!-- Label style: hide when collapsed -->
 <Style x:Key="ActionBarButtonTextStyle" TargetType="TextBlock">
 <Setter Property="Visibility" Value="Visible"/>
 <Style.Triggers>
 <DataTrigger Binding="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource LessThan}, ConverterParameter=760}" Value="True">
 <Setter Property="Visibility" Value="Collapsed"/>
 </DataTrigger>
 </Style.Triggers>
 </Style>

 <!-- Text inside DataGrid cells: center vertically, small left indent, trim overflow -->
 <Style x:Key="GridCellTextCentered" TargetType="TextBlock">
 <Setter Property="VerticalAlignment" Value="Center"/>
 <Setter Property="Margin" Value="6,0,6,0"/>
 <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
 </Style>
 
 <!-- Brush for selected search match -->
 <SolidColorBrush x:Key="SelectedMatchBrush" Color="#FFE0A3"/>
 </UserControl.Resources>

 <Grid Background="{DynamicResource AppBackground}">
 <Grid.RowDefinitions>
 <RowDefinition Height="Auto"/>
 <RowDefinition Height="Auto"/>
 <RowDefinition Height="*"/>
 </Grid.RowDefinitions>

 <!-- Top toolbar -->
 <Border Grid.Row="0" Background="{DynamicResource SurfaceBrush}" BorderBrush="{DynamicResource FieldBorderBrush}" BorderThickness="0,0,0,1" Padding="4" CornerRadius="6" Margin="5,6,5,4">
 <DockPanel>
 <Menu DockPanel.Dock="Top" Background="{DynamicResource SurfaceBrush}" BorderThickness="0">
 <MenuItem Header="Файл">
 <MenuItem Header="Импорт из Excel" Command="{Binding ImportFromExcelCommand}"/>
 <MenuItem Header="Экспорт в Excel" Command="{Binding ExportToExcelCommand}"/>
 <Separator/>
 <MenuItem Header="Создать резервную копию" Command="{Binding BackupCommand}"/>
 <MenuItem Header="Восстановить из копии" Command="{Binding RestoreCommand}"/>
 </MenuItem>
 <MenuItem Header="Поиск" Command="{Binding ShowSearchCommand}"/>
 </Menu>
 </DockPanel>
 </Border>

 <!-- Search toolbar -->
 <Border Grid.Row="1" Background="#FFF8E1" BorderBrush="#FFC107" BorderThickness="0,1,0,1" Visibility="{Binding IsSearchVisible, Converter={StaticResource BoolToVis}}" CornerRadius="4" Margin="5,4,5,0" HorizontalAlignment="Left">
 <Grid Margin="4">
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="Auto"/>
 </Grid.ColumnDefinitions>
 <Border Grid.Column="0" Background="White" BorderBrush="LightGray" BorderThickness="1" CornerRadius="3" Padding="4,1" VerticalAlignment="Center">
 <Grid>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="200"/>
 </Grid.ColumnDefinitions>
 <TextBlock Grid.Column="0" FontFamily="Segoe MDL2 Assets" Text="&#xE721;" Foreground="#7A7A7A" VerticalAlignment="Center" Margin="2,0,6,0"/>
 <TextBox Grid.Column="1" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" VerticalContentAlignment="Center" BorderThickness="0" Background="Transparent"/>
 </Grid>
 </Border>
 <TextBlock Grid.Column="1" Text="{Binding MatchInfo}" Margin="8,0" VerticalAlignment="Center" Foreground="Gray" MinWidth="100" TextAlignment="Right"/>
 <Button Grid.Column="2" Style="{StaticResource SearchIconButtonStyle}" Command="{Binding PreviousMatchCommand}" ToolTip="Предыдущее совпадение">
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE76B;"/>
 </Button>
 <Button Grid.Column="3" Style="{StaticResource SearchIconButtonStyle}" Command="{Binding NextMatchCommand}" ToolTip="Следующее совпадение" Margin="4,0,0,0">
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE76C;"/>
 </Button>
 <Button Grid.Column="4" Style="{StaticResource SearchCloseButtonStyle}" Command="{Binding CloseSearchCommand}" ToolTip="Закрыть поиск (Esc)" Margin="8,0,0,0">
 <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE711;" FontSize="14"/>
 </Button>
 </Grid>
 </Border>

 <!-- Grid and floating action bar -->
 <Border Grid.Row="2" Margin="5" Style="{StaticResource PanelBorder.Secondary}">
 <Grid>
 <DataGrid x:Name="RecipientsGrid"
 ItemsSource="{Binding RecipientsCollection}"
 SelectedItem="{Binding SelectedRecipient, Mode=TwoWay}"
 AutoGenerateColumns="False" IsReadOnly="True" SelectionMode="Single"
 ContextMenuOpening="RecipientsGrid_ContextMenuOpening"
 PreviewKeyDown="RecipientsGrid_PreviewKeyDown"
 RowHeaderWidth="0" CanUserAddRows="False" CanUserDeleteRows="False" CanUserReorderColumns="True" CanUserResizeRows="False"
 EnableRowVirtualization="True" HeadersVisibility="Column" GridLinesVisibility="Horizontal">
 <DataGrid.ContextMenu>
 <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
 <MenuItem Header="Редактировать" Command="{Binding EditCommand}"/>
 <MenuItem Header="Удалить" Command="{Binding DeleteCommand}"/>
 </ContextMenu>
 </DataGrid.ContextMenu>
 <!-- Row style -->
 <DataGrid.RowStyle>
 <Style TargetType="DataGridRow">
 <Setter Property="SnapsToDevicePixels" Value="True"/>
 <Setter Property="VerticalAlignment" Value="Center"/>
 <Style.Triggers>
 <DataTrigger Binding="{Binding IsMatch}" Value="True">
 <Setter Property="Background" Value="#FFF9C4"/>
 </DataTrigger>
 <!-- Selection active/focused -->
 <Trigger Property="IsSelected" Value="True">
 <Setter Property="Background" Value="#0F6CBD"/>
 <Setter Property="Foreground" Value="White"/>
 </Trigger>
 <!-- Keep same color even if DataGrid loses focus -->
 <MultiTrigger>
 <MultiTrigger.Conditions>
 <Condition Property="IsSelected" Value="True"/>
 <Condition Property="IsKeyboardFocusWithin" Value="False"/>
 </MultiTrigger.Conditions>
 <Setter Property="Background" Value="#0F6CBD"/>
 <Setter Property="Foreground" Value="White"/>
 </MultiTrigger>
 <MultiDataTrigger>
 <MultiDataTrigger.Conditions>
 <Condition Binding="{Binding IsMatch}" Value="True"/>
 <Condition Binding="{Binding RelativeSource={RelativeSource Self}, Path=IsSelected}" Value="True"/>
 </MultiDataTrigger.Conditions>
 <Setter Property="Background" Value="{StaticResource SelectedMatchBrush}"/>
 <Setter Property="Foreground" Value="Black"/>
 </MultiDataTrigger>
 </Style.Triggers>
 </Style>
 </DataGrid.RowStyle>
 <DataGrid.Columns>
 <DataGridTextColumn Header="Учреждение" Binding="{Binding OrganizationName}" Width="2*" ElementStyle="{StaticResource GridCellTextCentered}"/>
 <DataGridTextColumn Header="Улица" Binding="{Binding AddressLine1}" Width="3*" ElementStyle="{StaticResource GridCellTextCentered}"/>
 <DataGridTextColumn Header="Индекс" Binding="{Binding PostalCode}" Width="*" ElementStyle="{StaticResource GridCellTextCentered}"/>
 <DataGridTextColumn Header="Город" Binding="{Binding City}" Width="*" ElementStyle="{StaticResource GridCellTextCentered}"/>
 <DataGridTextColumn Header="Область" Binding="{Binding Region}" Width="*" ElementStyle="{StaticResource GridCellTextCentered}"/>
 <DataGridTextColumn Header="Страна" Binding="{Binding Country}" Width="*" ElementStyle="{StaticResource GridCellTextCentered}"/>
 </DataGrid.Columns>
 </DataGrid>

 <!-- Floating actions -->
 <Border HorizontalAlignment="Center" VerticalAlignment="Bottom" Panel.ZIndex="100" Margin="0,0,0,12" Background="Transparent">
 <Border Background="White" BorderBrush="Gainsboro" BorderThickness="1" CornerRadius="6" Padding="6">
 <Border.Effect>
 <DropShadowEffect ShadowDepth="3" Color="Gray" Opacity="0.3" BlurRadius="6"/>
 </Border.Effect>
 <WrapPanel>
 <Button Style="{StaticResource ActionBarButtonStyle}" Command="{Binding AddCommand}" ToolTip="Добавить">
 <Grid>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="*"/>
 </Grid.ColumnDefinitions>
 <TextBlock Grid.Column="0" FontFamily="Segoe MDL2 Assets" Text="&#xE710;" VerticalAlignment="Center"/>
 <TextBlock Grid.Column="1" Text="Добавить" Margin="8,0,0,0" Style="{StaticResource ActionBarButtonTextStyle}"/>
 </Grid>
 </Button>

 <Button Style="{StaticResource ActionBarButtonStyle}" Command="{Binding EditCommand}" ToolTip="Редактировать">
 <Grid>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="*"/>
 </Grid.ColumnDefinitions>
 <TextBlock Grid.Column="0" FontFamily="Segoe MDL2 Assets" Text="&#xE70F;" VerticalAlignment="Center"/>
 <TextBlock Grid.Column="1" Text="Редактировать" Margin="8,0,0,0" Style="{StaticResource ActionBarButtonTextStyle}"/>
 </Grid>
 </Button>

 <Button Style="{StaticResource ActionBarButtonStyle}" Command="{Binding DeleteCommand}" ToolTip="Удалить">
 <Grid>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="*"/>
 </Grid.ColumnDefinitions>
 <TextBlock Grid.Column="0" FontFamily="Segoe MDL2 Assets" Text="&#xE74D;" VerticalAlignment="Center"/>
 <TextBlock Grid.Column="1" Text="Удалить" Margin="8,0,0,0" Style="{StaticResource ActionBarButtonTextStyle}"/>
 </Grid>
 </Button>

 <Button Style="{StaticResource ActionBarButtonStyle}" Command="{Binding ShowSearchCommand}" ToolTip="Найти">
 <Grid>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="*"/>
 </Grid.ColumnDefinitions>
 <TextBlock Grid.Column="0" FontFamily="Segoe MDL2 Assets" Text="&#xE721;" VerticalAlignment="Center"/>
 <TextBlock Grid.Column="1" Text="Найти" Margin="8,0,0,0" Style="{StaticResource ActionBarButtonTextStyle}"/>
 </Grid>
 </Button>

 <Button Style="{StaticResource ActionBarButtonStyle}" Command="{Binding SelectPreviousRowCommand}" ToolTip="Вверх">
 <Grid>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="*"/>
 </Grid.ColumnDefinitions>
 <TextBlock Grid.Column="0" FontFamily="Segoe MDL2 Assets" Text="&#xE70E;" VerticalAlignment="Center"/>
 <TextBlock Grid.Column="1" Text="Вверх" Margin="8,0,0,0" Style="{StaticResource ActionBarButtonTextStyle}"/>
 </Grid>
 </Button>

 <Button Style="{StaticResource ActionBarButtonStyle}" Command="{Binding SelectNextRowCommand}" ToolTip="Вниз">
 <Grid>
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="Auto"/>
 <ColumnDefinition Width="*"/>
 </Grid.ColumnDefinitions>
 <TextBlock Grid.Column="0" FontFamily="Segoe MDL2 Assets" Text="&#xE70D;" VerticalAlignment="Center"/>
 <TextBlock Grid.Column="1" Text="Вниз" Margin="8,0,0,0" Style="{StaticResource ActionBarButtonTextStyle}"/>
 </Grid>
 </Button>
 </WrapPanel>
 </Border>
 </Border>
 </Grid>
 </Border>
 </Grid>
</UserControl>